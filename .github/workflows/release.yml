name: 'Release Tauri App'

on:
  push:
    branches:
      - main

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      app_version: ${{ steps.app-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'yarn'

      - name: Get app version
        id: app-version
        shell: bash
        run: echo "version=$(node -p "require('./src-tauri/tauri.conf.json').version")" >> $GITHUB_OUTPUT

      - name: Read release notes
        id: release-notes
        shell: bash
        run: |
          NOTES=$(cat release_note.txt)
          NOTES="${NOTES//'%'/'%25'}"
          NOTES="${NOTES//$'\n'/'%0A'}"
          NOTES="${NOTES//$'\r'/'%0D'}"
          echo "notes=$NOTES" >> $GITHUB_OUTPUT

      - name: Create Release
        shell: bash
        run: |
          gh release create "v${{ steps.app-version.outputs.version }}" \
            --title "Leaf Desktop v${{ steps.app-version.outputs.version }}" \
            --notes "${{ steps.release-notes.outputs.notes }}" \
            --draft
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  # Build for all platforms using yarn release
  build-platforms:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows build
          - platform: windows-latest
            targets: "--target x86_64-pc-windows-msvc --target i686-pc-windows-msvc --target aarch64-pc-windows-msvc"

          # Linux build (x86_64 and ARM)
          - platform: ubuntu-22.04
            targets: "--target x86_64-unknown-linux-gnu --target aarch64-unknown-linux-gnu --target armv7-unknown-linux-gnueabihf"

          # macOS build
          - platform: macos-latest
            targets: "--target x86_64-apple-darwin --target aarch64-apple-darwin"

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      # Setup Node.js and Rust
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'yarn'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # Rust caching
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          save-if: ${{ github.ref == 'refs/heads/main' }}

      # Install Linux dependencies
      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      # Configure Cargo registry
      - name: Configure Cargo registry
        shell: bash
        run: |
          mkdir -p ~/.cargo
          cat << EOF > ~/.cargo/config.toml
          [registries.kellnr]
          index = "sparse+https://cargo.surfshield.org/api/v1/crates/"
          credential-provider = ["cargo:token"]
          
          [registry]
          token = "${{ secrets.CARGO_REGISTRIES_KELLNR_TOKEN }}"
          EOF

      # Set up environment variables
      - name: Set up build environment
        shell: bash
        run: |
          echo "TAURI_SIGNING_PRIVATE_KEY=${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" >> $GITHUB_ENV
          echo "TAURI_SIGNING_PRIVATE_KEY_PASSWORD=${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}" >> $GITHUB_ENV
          echo "CARGO_REGISTRIES_KELLNR_TOKEN=${{ secrets.CARGO_REGISTRIES_KELLNR_TOKEN }}" >> $GITHUB_ENV
          echo "UPLOAD_API_URL=${{ secrets.UPLOAD_API_URL }}" >> $GITHUB_ENV
          echo "UPLOAD_API_KEY=${{ secrets.UPLOAD_API_KEY }}" >> $GITHUB_ENV

      # Run yarn release with appropriate targets and publish flag
      - name: Build and publish with yarn release
        shell: bash
        run: |
          yarn && yarn release ${{ matrix.targets }} --publish

      # Create a directory to store all extracted files
      - name: Prepare extraction directory
        shell: bash
        run: mkdir -p release_files

      # Extract all zips for GitHub release
      - name: Extract zips for GitHub release
        shell: bash
        run: |
          for zip in release/*.zip; do
            if [ -f "$zip" ]; then
              echo "Extracting $zip"
              unzip -o "$zip" -d release_files
            fi
          done

      # Upload all extracted files to GitHub release
      - name: Upload files to GitHub release
        shell: bash
        run: |
          cd release_files
          for file in *; do
            if [ -f "$file" ]; then
              echo "Uploading $file to GitHub release"
              gh release upload "v${{ needs.create-release.outputs.app_version }}" "$file" --clobber
            fi
          done
          
          # Also upload the original zip files
          cd ../release
          for zip in *.zip; do
            if [ -f "$zip" ]; then
              echo "Uploading zip $zip to GitHub release"
              gh release upload "v${{ needs.create-release.outputs.app_version }}" "$zip" --clobber
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  # Final step - publish the release after all builds are done
  publish-release:
    needs: [ create-release, build-platforms ]
    runs-on: ubuntu-latest
    # Only run if all builds succeeded
    if: success()
    steps:
      - name: Publish Release
        shell: bash
        run: |
          gh release edit "v${{ needs.create-release.outputs.app_version }}" --draft=false
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
