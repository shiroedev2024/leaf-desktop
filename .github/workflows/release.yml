# .github/workflows/release.yml
name: 'Build and Release'

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish the release'
        type: boolean
        default: true

jobs:
  publish-tauri:
    permissions:
      contents: write
    outputs:
      app_version: ${{ steps.tauri_action.outputs.appVersion }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest' # for Arm based macs (M1 and above).
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest' # for Intel based macs.
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''
          - platform: 'windows-latest'
            args: '--target i686-pc-windows-msvc' # for 32-bit Windows
          - platform: 'windows-latest'
            args: '--target aarch64-pc-windows-msvc' # for ARM64 Windows
          - platform: 'ubuntu-22.04'
            args: '--target aarch64-unknown-linux-gnu' # for ARM64 Linux
          - platform: 'ubuntu-22.04'
            args: '--target i686-unknown-linux-gnu' # for 32-bit Linux

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Read release notes
        id: release-notes
        run: |
          NOTES=$(cat release_note.txt)
          echo "NOTES<<EOF" >> $GITHUB_ENV
          echo "$NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'yarn'

      - name: Extract target from args
        id: extract-target
        run: |
          if [[ "${{ matrix.args }}" == *"--target "* ]]; then
            TARGET=$(echo "${{ matrix.args }}" | sed -n 's/.*--target \([^ ]*\).*/\1/p')
            echo "target=$TARGET" >> $GITHUB_OUTPUT
          else
            if [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
              echo "target=x86_64-apple-darwin,aarch64-apple-darwin" >> $GITHUB_OUTPUT
            else
              echo "target=" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ steps.extract-target.outputs.target }}

      - name: Install dependencies (ubuntu only)
        if: startsWith(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install app dependencies
        run: yarn install

      - name: Set environment variables
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          CARGO_REGISTRIES_KELLNR_TOKEN: ${{ secrets.CARGO_REGISTRIES_KELLNR_TOKEN }}
        run: |
          # Create .env file for tauri-action to use
          echo "TAURI_SIGNING_PRIVATE_KEY='$TAURI_SIGNING_PRIVATE_KEY'" > .env
          echo "TAURI_SIGNING_PRIVATE_KEY_PASSWORD='$TAURI_SIGNING_PRIVATE_KEY_PASSWORD'" >> .env
          echo "CARGO_REGISTRIES_KELLNR_TOKEN='$CARGO_REGISTRIES_KELLNR_TOKEN'" >> .env

      - name: Build and publish Tauri app
        id: tauri_action
        uses: tauri-apps/tauri-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        with:
          tagName: v__VERSION__
          releaseName: 'Release v__VERSION__'
          releaseBody: ${{ env.NOTES }}
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}

      - name: Save artifacts for publishing
        if: matrix.args != ''
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.platform }}-${{ matrix.args }}
          path: |
            src-tauri/target/*/release/bundle/**/*.{exe,msi,deb,rpm,app.tar.gz,dmg,AppImage}
            src-tauri/target/*/release/bundle/**/*.{sig,hash}
          retention-days: 3

  publish-to-custom-api:
    needs: [ publish-tauri ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract and organize release files
        run: |
          mkdir -p release_files
          # Extract all files from artifacts directory
          find artifacts -type f -not -path "*/\.*" | while read file; do
            # Get the basename of the file
            filename=$(basename "$file")
            # Copy to release_files directory
            cp "$file" "release_files/$filename"
          done
          
          # List all found files
          echo "Files for upload:"
          ls -la release_files/

      - name: Upload to custom API
        env:
          UPLOAD_API_URL: ${{ secrets.UPLOAD_API_URL }}
          UPLOAD_API_KEY: ${{ secrets.UPLOAD_API_KEY }}
          VERSION: ${{ needs.publish-tauri.outputs.app_version }}
        run: |
          # Find and process all Windows executables
          windows_files=$(find release_files -name "*.exe" -o -name "*.msi")
          if [ ! -z "$windows_files" ]; then
            # Create a windows zip
            mkdir -p windows
            cp $windows_files windows/
            zip -r windows.zip windows/
          
            # Upload Windows release
            curl -X POST "$UPLOAD_API_URL" \
              -H "X-API-Key: $UPLOAD_API_KEY" \
              -F "zip=@windows.zip" \
              -F "platform=windows" \
              -F "version=$VERSION" \
              -F "source=github-actions" \
              -F "change_log[0][lang_code]=en" \
              -F "change_log[0][text]=$(cat release_note.txt)"
          fi
          
          # Find and process all macOS packages
          macos_files=$(find release_files -name "*.app.tar.gz" -o -name "*.dmg")
          if [ ! -z "$macos_files" ]; then
            # Create a macOS zip
            mkdir -p macos
            cp $macos_files macos/
            zip -r macos.zip macos/
          
            # Upload macOS release
            curl -X POST "$UPLOAD_API_URL" \
              -H "X-API-Key: $UPLOAD_API_KEY" \
              -F "zip=@macos.zip" \
              -F "platform=macos" \
              -F "version=$VERSION" \
              -F "source=github-actions" \
              -F "change_log[0][lang_code]=en" \
              -F "change_log[0][text]=$(cat release_note.txt)"
          fi
          
          # Find and process all Linux packages
          linux_files=$(find release_files -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage")
          if [ ! -z "$linux_files" ]; then
            # Create a Linux zip
            mkdir -p linux
            cp $linux_files linux/
            zip -r linux.zip linux/
          
            # Upload Linux release
            curl -X POST "$UPLOAD_API_URL" \
              -H "X-API-Key: $UPLOAD_API_KEY" \
              -F "zip=@linux.zip" \
              -F "platform=linux" \
              -F "version=$VERSION" \
              -F "source=github-actions" \
              -F "change_log[0][lang_code]=en" \
              -F "change_log[0][text]=$(cat release_note.txt)"
          fi
